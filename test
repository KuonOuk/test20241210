import boto3

def get_athena_query_details():
    # Athenaクライアントの初期化
    client = boto3.client('athena', region_name='your-region')  # 適切なリージョンを指定
    query_ids = client.list_query_executions()['QueryExecutionIds']

    # クエリ統計を初期化
    succeeded_ddl = 0
    succeeded_dml = 0
    max_ddl_time = 0  # 最大実行時間 (ミリ秒)
    max_dml_time = 0  # 最大実行時間 (ミリ秒)

    # 各クエリIDを取得して処理
    for query_id in query_ids:
        query_execution = client.get_query_execution(QueryExecutionId=query_id)
        state = query_execution['QueryExecution']['Status']['State']  # クエリステータスを取得
        statement_type = query_execution['QueryExecution']['StatementType']  # StatementTypeを取得
        execution_time = query_execution['QueryExecution']['Statistics'].get('TotalExecutionTimeInMillis', 0)

        # ステータスが SUCCEEDED の場合のみ処理
        if state == "SUCCEEDED":
            if statement_type == "DDL":
                succeeded_ddl += 1
                max_ddl_time = max(max_ddl_time, execution_time)
            elif statement_type == "DML":
                succeeded_dml += 1
                max_dml_time = max(max_dml_time, execution_time)

    # ミリ秒を分に変換
    max_ddl_time_minutes = max_ddl_time / (1000 * 60)
    max_dml_time_minutes = max_dml_time / (1000 * 60)

    return {
        "succeeded_ddl": succeeded_ddl,
        "succeeded_dml": succeeded_dml,
        "max_ddl_time_minutes": max_ddl_time_minutes,
        "max_dml_time_minutes": max_dml_time_minutes,
    }


if __name__ == "__main__":
    result = get_athena_query_details()
    print("成功したDDLクエリ数:", result["succeeded_ddl"])
    print("成功したDMLクエリ数:", result["succeeded_dml"])
    print("DDLクエリの最大実行時間 (分):", round(result["max_ddl_time_minutes"], 2))
    print("DMLクエリの最大実行時間 (分):", round(result["max_dml_time_minutes"], 2))
